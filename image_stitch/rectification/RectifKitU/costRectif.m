function [err,jac]  = costRectif(a,w,h,ml,mr) ;
%costRectif  Compute rectification cost
%
% a is a vector of six elements containing the independent
% variables of the cost function, i.e, five rotation angles
% (Y-left, Z-left, X-right, Y-right, Z-right) and the focal
% lenght.
% w,h are the image width and height, respectively.
% m1,m2 are the corresponding image points.

% Author: A. Fusiello, 2006

% recover parameters
yl=a(1); zl=a(2); xr=a(3);
yr=a(4); zr=a(5); f =3^a(6)*(w+h);

% estimate of the intrinsic parameters of the old cameras
Kol = [f, 0, w/2;  0, f, h/2; 0, 0, 1];
Kor = Kol;

% eulR applies rotations in the order Y-Z-X
Rl = eulR([0,yl,zl]);
Rr = eulR([xr,yr,zr]);

% fundamental matrix btw original points
F = inv(Kor)'*Rr'*star([1 0 0])*Rl*inv(Kol);

% compute Sampson error
% err = sqrt(sampson(F,ml,mr));

m1 = [ml;ones(1,size(ml,2))];
m2 = [mr;ones(1,size(mr,2))];

U3 = star([0 0 1]);

err =[];

for n = 1:size(m1,2);

    ufm1 = U3*F*m1(:,n);
    m2fu = m2(:,n)'*F*U3;
    
    s = sqrt((m2(:,n)'*F*m1(:,n))^2 / (ufm1'*ufm1 + m2fu*m2fu'));
    err = [err, s];

end

if nargout > 1   % Two output arguments: compute Jacobian


    %disp('jacobian')

    wph = w+h;
    u0 = w/2;
    v0 = h/2;
    a6 = a(6);

    
    % vec(F)
    f1 = F(1,1); f4 = F(1,2); f7 = F(1,3);
    f2 = F(2,1); f5 = F(2,2); f8 = F(2,3);
    f3 = F(3,1); f6 = F(3,2); f9 = F(3,3);

    jac =[];

    for n = 1:size(m1,2);

        m11 = m1(1,n);
        m12 = m1(2,n);
        m21 = m2(1,n);
        m22 = m2(2,n);

 
df =...
[                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (-1/(3^a6)/wph*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))*sin(zl)*sin(yl)+1/(3^a6)/wph*(cos(xr)*sin(zr)*cos(yr)+sin(xr)*sin(yr))*cos(yl))/(3^a6)/wph,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           1/(3^a6)^2/wph^2*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))*cos(zl)*cos(yl),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (1/(3^a6)/wph*(cos(xr)*sin(zr)*cos(yr)+sin(xr)*sin(yr))*sin(zl)*cos(yl)+1/(3^a6)/wph*(-sin(xr)*sin(zr)*cos(yr)+cos(xr)*sin(yr))*sin(yl))/(3^a6)/wph,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (1/(3^a6)/wph*(-sin(xr)*sin(zr)*sin(yr)-cos(xr)*cos(yr))*sin(zl)*cos(yl)+1/(3^a6)/wph*(-cos(xr)*sin(zr)*sin(yr)+sin(xr)*cos(yr))*sin(yl))/(3^a6)/wph,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       (1/(3^a6)/wph*sin(xr)*cos(zr)*cos(yr)*sin(zl)*cos(yl)+1/(3^a6)/wph*cos(xr)*cos(zr)*cos(yr)*sin(yl))/(3^a6)/wph,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          (-1/(3^a6)/wph*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))*sin(zl)*cos(yl)*log(3)-1/(3^a6)/wph*(cos(xr)*sin(zr)*cos(yr)+sin(xr)*sin(yr))*sin(yl)*log(3))/(3^a6)/wph-(1/(3^a6)/wph*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))*sin(zl)*cos(yl)+1/(3^a6)/wph*(cos(xr)*sin(zr)*cos(yr)+sin(xr)*sin(yr))*sin(yl))/(3^a6)/wph*log(3);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      (-1/(3^a6)/wph*sin(xr)*cos(zr)*sin(zl)*sin(yl)+1/(3^a6)/wph*cos(xr)*cos(zr)*cos(yl))/(3^a6)/wph,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     1/(3^a6)^2/wph^2*sin(xr)*cos(zr)*cos(zl)*cos(yl),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       (1/(3^a6)/wph*cos(xr)*cos(zr)*sin(zl)*cos(yl)-1/(3^a6)/wph*sin(xr)*cos(zr)*sin(yl))/(3^a6)/wph,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      (-1/(3^a6)/wph*sin(xr)*sin(zr)*sin(zl)*cos(yl)-1/(3^a6)/wph*cos(xr)*sin(zr)*sin(yl))/(3^a6)/wph,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (-1/(3^a6)/wph*sin(xr)*cos(zr)*sin(zl)*cos(yl)*log(3)-1/(3^a6)/wph*cos(xr)*cos(zr)*sin(yl)*log(3))/(3^a6)/wph-(1/(3^a6)/wph*sin(xr)*cos(zr)*sin(zl)*cos(yl)+1/(3^a6)/wph*cos(xr)*cos(zr)*sin(yl))/(3^a6)/wph*log(3);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           (-(-u0/(3^a6)/wph*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))-1/(3^a6)/wph*v0*sin(xr)*cos(zr)+sin(xr)*sin(zr)*sin(yr)+cos(xr)*cos(yr))*sin(zl)*sin(yl)-(u0/(3^a6)/wph*(cos(xr)*sin(zr)*cos(yr)+sin(xr)*sin(yr))+1/(3^a6)/wph*v0*cos(xr)*cos(zr)-cos(xr)*sin(zr)*sin(yr)+sin(xr)*cos(yr))*cos(yl))/(3^a6)/wph,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        (-u0/(3^a6)/wph*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))-1/(3^a6)/wph*v0*sin(xr)*cos(zr)+sin(xr)*sin(zr)*sin(yr)+cos(xr)*cos(yr))*cos(zl)*cos(yl)/(3^a6)/wph,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ((-u0/(3^a6)/wph*(cos(xr)*sin(zr)*cos(yr)+sin(xr)*sin(yr))-1/(3^a6)/wph*v0*cos(xr)*cos(zr)+cos(xr)*sin(zr)*sin(yr)-sin(xr)*cos(yr))*sin(zl)*cos(yl)-(u0/(3^a6)/wph*(-sin(xr)*sin(zr)*cos(yr)+cos(xr)*sin(yr))-1/(3^a6)/wph*v0*sin(xr)*cos(zr)+sin(xr)*sin(zr)*sin(yr)+cos(xr)*cos(yr))*sin(yl))/(3^a6)/wph,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ((-u0/(3^a6)/wph*(-sin(xr)*sin(zr)*sin(yr)-cos(xr)*cos(yr))+sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))*sin(zl)*cos(yl)-(u0/(3^a6)/wph*(-cos(xr)*sin(zr)*sin(yr)+sin(xr)*cos(yr))-cos(xr)*sin(zr)*cos(yr)-sin(xr)*sin(yr))*sin(yl))/(3^a6)/wph,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ((-u0/(3^a6)/wph*sin(xr)*cos(zr)*cos(yr)+1/(3^a6)/wph*v0*sin(xr)*sin(zr)+sin(xr)*cos(zr)*sin(yr))*sin(zl)*cos(yl)-(u0/(3^a6)/wph*cos(xr)*cos(zr)*cos(yr)-1/(3^a6)/wph*v0*cos(xr)*sin(zr)-cos(xr)*cos(zr)*sin(yr))*sin(yl))/(3^a6)/wph,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ((u0/(3^a6)/wph*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))*log(3)+1/(3^a6)/wph*v0*sin(xr)*cos(zr)*log(3))*sin(zl)*cos(yl)-(-u0/(3^a6)/wph*(cos(xr)*sin(zr)*cos(yr)+sin(xr)*sin(yr))*log(3)-1/(3^a6)/wph*v0*cos(xr)*cos(zr)*log(3))*sin(yl))/(3^a6)/wph-((-u0/(3^a6)/wph*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))-1/(3^a6)/wph*v0*sin(xr)*cos(zr)+sin(xr)*sin(zr)*sin(yr)+cos(xr)*cos(yr))*sin(zl)*cos(yl)-(u0/(3^a6)/wph*(cos(xr)*sin(zr)*cos(yr)+sin(xr)*sin(yr))+1/(3^a6)/wph*v0*cos(xr)*cos(zr)-cos(xr)*sin(zr)*sin(yr)+sin(xr)*cos(yr))*sin(yl))/(3^a6)/wph*log(3);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  -1/(3^a6)^2/wph^2*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))*sin(zl),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   1/(3^a6)^2/wph^2*(cos(xr)*sin(zr)*cos(yr)+sin(xr)*sin(yr))*cos(zl),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  1/(3^a6)^2/wph^2*(-sin(xr)*sin(zr)*sin(yr)-cos(xr)*cos(yr))*cos(zl),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     1/(3^a6)^2/wph^2*sin(xr)*cos(zr)*cos(yr)*cos(zl),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           -2/(3^a6)^2/wph^2*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))*cos(zl)*log(3);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            -1/(3^a6)^2/wph^2*sin(xr)*cos(zr)*sin(zl),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             1/(3^a6)^2/wph^2*cos(xr)*cos(zr)*cos(zl),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            -1/(3^a6)^2/wph^2*sin(xr)*sin(zr)*cos(zl),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     -2/(3^a6)^2/wph^2*sin(xr)*cos(zr)*cos(zl)*log(3);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               -(-u0/(3^a6)/wph*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))-1/(3^a6)/wph*v0*sin(xr)*cos(zr)+sin(xr)*sin(zr)*sin(yr)+cos(xr)*cos(yr))*sin(zl)/(3^a6)/wph,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                (-u0/(3^a6)/wph*(cos(xr)*sin(zr)*cos(yr)+sin(xr)*sin(yr))-1/(3^a6)/wph*v0*cos(xr)*cos(zr)+cos(xr)*sin(zr)*sin(yr)-sin(xr)*cos(yr))*cos(zl)/(3^a6)/wph,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (-u0/(3^a6)/wph*(-sin(xr)*sin(zr)*sin(yr)-cos(xr)*cos(yr))+sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))*cos(zl)/(3^a6)/wph,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (-u0/(3^a6)/wph*sin(xr)*cos(zr)*cos(yr)+1/(3^a6)/wph*v0*sin(xr)*sin(zr)+sin(xr)*cos(zr)*sin(yr))*cos(zl)/(3^a6)/wph,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              (u0/(3^a6)/wph*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))*log(3)+1/(3^a6)/wph*v0*sin(xr)*cos(zr)*log(3))*cos(zl)/(3^a6)/wph-(-u0/(3^a6)/wph*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))-1/(3^a6)/wph*v0*sin(xr)*cos(zr)+sin(xr)*sin(zr)*sin(yr)+cos(xr)*cos(yr))*cos(zl)/(3^a6)/wph*log(3);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        -(-1/(3^a6)/wph*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))*sin(zl)*sin(yl)+1/(3^a6)/wph*(cos(xr)*sin(zr)*cos(yr)+sin(xr)*sin(yr))*cos(yl))*u0/(3^a6)/wph+1/(3^a6)/wph*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))*sin(zl)*cos(yl)+1/(3^a6)/wph*(cos(xr)*sin(zr)*cos(yr)+sin(xr)*sin(yr))*sin(yl),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          -1/(3^a6)^2/wph^2*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))*cos(zl)*cos(yl)*u0+1/(3^a6)^2/wph^2*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))*sin(zl)*v0+1/(3^a6)/wph*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))*cos(zl)*sin(yl),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 -(1/(3^a6)/wph*(cos(xr)*sin(zr)*cos(yr)+sin(xr)*sin(yr))*sin(zl)*cos(yl)+1/(3^a6)/wph*(-sin(xr)*sin(zr)*cos(yr)+cos(xr)*sin(yr))*sin(yl))*u0/(3^a6)/wph-1/(3^a6)^2/wph^2*(cos(xr)*sin(zr)*cos(yr)+sin(xr)*sin(yr))*cos(zl)*v0+1/(3^a6)/wph*(cos(xr)*sin(zr)*cos(yr)+sin(xr)*sin(yr))*sin(zl)*sin(yl)-1/(3^a6)/wph*(-sin(xr)*sin(zr)*cos(yr)+cos(xr)*sin(yr))*cos(yl),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              -(1/(3^a6)/wph*(-sin(xr)*sin(zr)*sin(yr)-cos(xr)*cos(yr))*sin(zl)*cos(yl)+1/(3^a6)/wph*(-cos(xr)*sin(zr)*sin(yr)+sin(xr)*cos(yr))*sin(yl))*u0/(3^a6)/wph-1/(3^a6)^2/wph^2*(-sin(xr)*sin(zr)*sin(yr)-cos(xr)*cos(yr))*cos(zl)*v0+1/(3^a6)/wph*(-sin(xr)*sin(zr)*sin(yr)-cos(xr)*cos(yr))*sin(zl)*sin(yl)-1/(3^a6)/wph*(-cos(xr)*sin(zr)*sin(yr)+sin(xr)*cos(yr))*cos(yl),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             -(1/(3^a6)/wph*sin(xr)*cos(zr)*cos(yr)*sin(zl)*cos(yl)+1/(3^a6)/wph*cos(xr)*cos(zr)*cos(yr)*sin(yl))*u0/(3^a6)/wph-1/(3^a6)^2/wph^2*sin(xr)*cos(zr)*cos(yr)*cos(zl)*v0+1/(3^a6)/wph*sin(xr)*cos(zr)*cos(yr)*sin(zl)*sin(yl)-1/(3^a6)/wph*cos(xr)*cos(zr)*cos(yr)*cos(yl),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  -(-1/(3^a6)/wph*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))*sin(zl)*cos(yl)*log(3)-1/(3^a6)/wph*(cos(xr)*sin(zr)*cos(yr)+sin(xr)*sin(yr))*sin(yl)*log(3))*u0/(3^a6)/wph+(1/(3^a6)/wph*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))*sin(zl)*cos(yl)+1/(3^a6)/wph*(cos(xr)*sin(zr)*cos(yr)+sin(xr)*sin(yr))*sin(yl))*u0/(3^a6)/wph*log(3)+2/(3^a6)^2/wph^2*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))*cos(zl)*v0*log(3)-1/(3^a6)/wph*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))*sin(zl)*sin(yl)*log(3)+1/(3^a6)/wph*(cos(xr)*sin(zr)*cos(yr)+sin(xr)*sin(yr))*cos(yl)*log(3);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                -(-1/(3^a6)/wph*sin(xr)*cos(zr)*sin(zl)*sin(yl)+1/(3^a6)/wph*cos(xr)*cos(zr)*cos(yl))*u0/(3^a6)/wph+1/(3^a6)/wph*sin(xr)*cos(zr)*sin(zl)*cos(yl)+1/(3^a6)/wph*cos(xr)*cos(zr)*sin(yl),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        -1/(3^a6)^2/wph^2*sin(xr)*cos(zr)*cos(zl)*cos(yl)*u0+1/(3^a6)^2/wph^2*sin(xr)*cos(zr)*sin(zl)*v0+1/(3^a6)/wph*sin(xr)*cos(zr)*cos(zl)*sin(yl),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     -(1/(3^a6)/wph*cos(xr)*cos(zr)*sin(zl)*cos(yl)-1/(3^a6)/wph*sin(xr)*cos(zr)*sin(yl))*u0/(3^a6)/wph-1/(3^a6)^2/wph^2*cos(xr)*cos(zr)*cos(zl)*v0+1/(3^a6)/wph*cos(xr)*cos(zr)*sin(zl)*sin(yl)+1/(3^a6)/wph*sin(xr)*cos(zr)*cos(yl),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    -(-1/(3^a6)/wph*sin(xr)*sin(zr)*sin(zl)*cos(yl)-1/(3^a6)/wph*cos(xr)*sin(zr)*sin(yl))*u0/(3^a6)/wph+1/(3^a6)^2/wph^2*sin(xr)*sin(zr)*cos(zl)*v0-1/(3^a6)/wph*sin(xr)*sin(zr)*sin(zl)*sin(yl)+1/(3^a6)/wph*cos(xr)*sin(zr)*cos(yl),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        -(-1/(3^a6)/wph*sin(xr)*cos(zr)*sin(zl)*cos(yl)*log(3)-1/(3^a6)/wph*cos(xr)*cos(zr)*sin(yl)*log(3))*u0/(3^a6)/wph+(1/(3^a6)/wph*sin(xr)*cos(zr)*sin(zl)*cos(yl)+1/(3^a6)/wph*cos(xr)*cos(zr)*sin(yl))*u0/(3^a6)/wph*log(3)+2/(3^a6)^2/wph^2*sin(xr)*cos(zr)*cos(zl)*v0*log(3)-1/(3^a6)/wph*sin(xr)*cos(zr)*sin(zl)*sin(yl)*log(3)+1/(3^a6)/wph*cos(xr)*cos(zr)*cos(yl)*log(3);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          -(-(-u0/(3^a6)/wph*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))-1/(3^a6)/wph*v0*sin(xr)*cos(zr)+sin(xr)*sin(zr)*sin(yr)+cos(xr)*cos(yr))*sin(zl)*sin(yl)-(u0/(3^a6)/wph*(cos(xr)*sin(zr)*cos(yr)+sin(xr)*sin(yr))+1/(3^a6)/wph*v0*cos(xr)*cos(zr)-cos(xr)*sin(zr)*sin(yr)+sin(xr)*cos(yr))*cos(yl))*u0/(3^a6)/wph+(-u0/(3^a6)/wph*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))-1/(3^a6)/wph*v0*sin(xr)*cos(zr)+sin(xr)*sin(zr)*sin(yr)+cos(xr)*cos(yr))*sin(zl)*cos(yl)-(u0/(3^a6)/wph*(cos(xr)*sin(zr)*cos(yr)+sin(xr)*sin(yr))+1/(3^a6)/wph*v0*cos(xr)*cos(zr)-cos(xr)*sin(zr)*sin(yr)+sin(xr)*cos(yr))*sin(yl),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        -(-u0/(3^a6)/wph*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))-1/(3^a6)/wph*v0*sin(xr)*cos(zr)+sin(xr)*sin(zr)*sin(yr)+cos(xr)*cos(yr))*cos(zl)*cos(yl)*u0/(3^a6)/wph+(-u0/(3^a6)/wph*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))-1/(3^a6)/wph*v0*sin(xr)*cos(zr)+sin(xr)*sin(zr)*sin(yr)+cos(xr)*cos(yr))*sin(zl)/(3^a6)/wph*v0+(-u0/(3^a6)/wph*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))-1/(3^a6)/wph*v0*sin(xr)*cos(zr)+sin(xr)*sin(zr)*sin(yr)+cos(xr)*cos(yr))*cos(zl)*sin(yl),                                                                                                                                                                                                                                                                                                                                                -((-u0/(3^a6)/wph*(cos(xr)*sin(zr)*cos(yr)+sin(xr)*sin(yr))-1/(3^a6)/wph*v0*cos(xr)*cos(zr)+cos(xr)*sin(zr)*sin(yr)-sin(xr)*cos(yr))*sin(zl)*cos(yl)-(u0/(3^a6)/wph*(-sin(xr)*sin(zr)*cos(yr)+cos(xr)*sin(yr))-1/(3^a6)/wph*v0*sin(xr)*cos(zr)+sin(xr)*sin(zr)*sin(yr)+cos(xr)*cos(yr))*sin(yl))*u0/(3^a6)/wph-(-u0/(3^a6)/wph*(cos(xr)*sin(zr)*cos(yr)+sin(xr)*sin(yr))-1/(3^a6)/wph*v0*cos(xr)*cos(zr)+cos(xr)*sin(zr)*sin(yr)-sin(xr)*cos(yr))*cos(zl)/(3^a6)/wph*v0+(-u0/(3^a6)/wph*(cos(xr)*sin(zr)*cos(yr)+sin(xr)*sin(yr))-1/(3^a6)/wph*v0*cos(xr)*cos(zr)+cos(xr)*sin(zr)*sin(yr)-sin(xr)*cos(yr))*sin(zl)*sin(yl)+(u0/(3^a6)/wph*(-sin(xr)*sin(zr)*cos(yr)+cos(xr)*sin(yr))-1/(3^a6)/wph*v0*sin(xr)*cos(zr)+sin(xr)*sin(zr)*sin(yr)+cos(xr)*cos(yr))*cos(yl),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             -((-u0/(3^a6)/wph*(-sin(xr)*sin(zr)*sin(yr)-cos(xr)*cos(yr))+sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))*sin(zl)*cos(yl)-(u0/(3^a6)/wph*(-cos(xr)*sin(zr)*sin(yr)+sin(xr)*cos(yr))-cos(xr)*sin(zr)*cos(yr)-sin(xr)*sin(yr))*sin(yl))*u0/(3^a6)/wph-(-u0/(3^a6)/wph*(-sin(xr)*sin(zr)*sin(yr)-cos(xr)*cos(yr))+sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))*cos(zl)/(3^a6)/wph*v0+(-u0/(3^a6)/wph*(-sin(xr)*sin(zr)*sin(yr)-cos(xr)*cos(yr))+sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))*sin(zl)*sin(yl)+(u0/(3^a6)/wph*(-cos(xr)*sin(zr)*sin(yr)+sin(xr)*cos(yr))-cos(xr)*sin(zr)*cos(yr)-sin(xr)*sin(yr))*cos(yl),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            -((-u0/(3^a6)/wph*sin(xr)*cos(zr)*cos(yr)+1/(3^a6)/wph*v0*sin(xr)*sin(zr)+sin(xr)*cos(zr)*sin(yr))*sin(zl)*cos(yl)-(u0/(3^a6)/wph*cos(xr)*cos(zr)*cos(yr)-1/(3^a6)/wph*v0*cos(xr)*sin(zr)-cos(xr)*cos(zr)*sin(yr))*sin(yl))*u0/(3^a6)/wph-(-u0/(3^a6)/wph*sin(xr)*cos(zr)*cos(yr)+1/(3^a6)/wph*v0*sin(xr)*sin(zr)+sin(xr)*cos(zr)*sin(yr))*cos(zl)/(3^a6)/wph*v0+(-u0/(3^a6)/wph*sin(xr)*cos(zr)*cos(yr)+1/(3^a6)/wph*v0*sin(xr)*sin(zr)+sin(xr)*cos(zr)*sin(yr))*sin(zl)*sin(yl)+(u0/(3^a6)/wph*cos(xr)*cos(zr)*cos(yr)-1/(3^a6)/wph*v0*cos(xr)*sin(zr)-cos(xr)*cos(zr)*sin(yr))*cos(yl), -((u0/(3^a6)/wph*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))*log(3)+1/(3^a6)/wph*v0*sin(xr)*cos(zr)*log(3))*sin(zl)*cos(yl)-(-u0/(3^a6)/wph*(cos(xr)*sin(zr)*cos(yr)+sin(xr)*sin(yr))*log(3)-1/(3^a6)/wph*v0*cos(xr)*cos(zr)*log(3))*sin(yl))*u0/(3^a6)/wph+((-u0/(3^a6)/wph*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))-1/(3^a6)/wph*v0*sin(xr)*cos(zr)+sin(xr)*sin(zr)*sin(yr)+cos(xr)*cos(yr))*sin(zl)*cos(yl)-(u0/(3^a6)/wph*(cos(xr)*sin(zr)*cos(yr)+sin(xr)*sin(yr))+1/(3^a6)/wph*v0*cos(xr)*cos(zr)-cos(xr)*sin(zr)*sin(yr)+sin(xr)*cos(yr))*sin(yl))*u0/(3^a6)/wph*log(3)-(u0/(3^a6)/wph*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))*log(3)+1/(3^a6)/wph*v0*sin(xr)*cos(zr)*log(3))*cos(zl)/(3^a6)/wph*v0+(-u0/(3^a6)/wph*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))-1/(3^a6)/wph*v0*sin(xr)*cos(zr)+sin(xr)*sin(zr)*sin(yr)+cos(xr)*cos(yr))*cos(zl)/(3^a6)/wph*v0*log(3)+(u0/(3^a6)/wph*(sin(xr)*sin(zr)*cos(yr)-cos(xr)*sin(yr))*log(3)+1/(3^a6)/wph*v0*sin(xr)*cos(zr)*log(3))*sin(zl)*sin(yl)+(-u0/(3^a6)/wph*(cos(xr)*sin(zr)*cos(yr)+sin(xr)*sin(yr))*log(3)-1/(3^a6)/wph*v0*cos(xr)*cos(zr)*log(3))*cos(yl)];
 
 
 ds =...
[   2*((m21*f1+m22*f2+f3)*m11+(m21*f4+m22*f5+f6)*m12+m21*f7+m22*f8+f9)/((-f2*m11-f5*m12-f8)^2+(f1*m11+f4*m12+f7)^2+(m21*f4+m22*f5+f6)^2+(-m21*f1-m22*f2-f3)^2)*m21*m11-((m21*f1+m22*f2+f3)*m11+(m21*f4+m22*f5+f6)*m12+m21*f7+m22*f8+f9)^2/((-f2*m11-f5*m12-f8)^2+(f1*m11+f4*m12+f7)^2+(m21*f4+m22*f5+f6)^2+(-m21*f1-m22*f2-f3)^2)^2*(2*(f1*m11+f4*m12+f7)*m11-2*(-m21*f1-m22*f2-f3)*m21), 2*((m21*f1+m22*f2+f3)*m11+(m21*f4+m22*f5+f6)*m12+m21*f7+m22*f8+f9)/((-f2*m11-f5*m12-f8)^2+(f1*m11+f4*m12+f7)^2+(m21*f4+m22*f5+f6)^2+(-m21*f1-m22*f2-f3)^2)*m22*m11-((m21*f1+m22*f2+f3)*m11+(m21*f4+m22*f5+f6)*m12+m21*f7+m22*f8+f9)^2/((-f2*m11-f5*m12-f8)^2+(f1*m11+f4*m12+f7)^2+(m21*f4+m22*f5+f6)^2+(-m21*f1-m22*f2-f3)^2)^2*(-2*(-f2*m11-f5*m12-f8)*m11-2*(-m21*f1-m22*f2-f3)*m22),                                   2*((m21*f1+m22*f2+f3)*m11+(m21*f4+m22*f5+f6)*m12+m21*f7+m22*f8+f9)/((-f2*m11-f5*m12-f8)^2+(f1*m11+f4*m12+f7)^2+(m21*f4+m22*f5+f6)^2+(-m21*f1-m22*f2-f3)^2)*m11-((m21*f1+m22*f2+f3)*m11+(m21*f4+m22*f5+f6)*m12+m21*f7+m22*f8+f9)^2/((-f2*m11-f5*m12-f8)^2+(f1*m11+f4*m12+f7)^2+(m21*f4+m22*f5+f6)^2+(-m21*f1-m22*f2-f3)^2)^2*(2*m21*f1+2*m22*f2+2*f3),    2*((m21*f1+m22*f2+f3)*m11+(m21*f4+m22*f5+f6)*m12+m21*f7+m22*f8+f9)/((-f2*m11-f5*m12-f8)^2+(f1*m11+f4*m12+f7)^2+(m21*f4+m22*f5+f6)^2+(-m21*f1-m22*f2-f3)^2)*m21*m12-((m21*f1+m22*f2+f3)*m11+(m21*f4+m22*f5+f6)*m12+m21*f7+m22*f8+f9)^2/((-f2*m11-f5*m12-f8)^2+(f1*m11+f4*m12+f7)^2+(m21*f4+m22*f5+f6)^2+(-m21*f1-m22*f2-f3)^2)^2*(2*(f1*m11+f4*m12+f7)*m12+2*(m21*f4+m22*f5+f6)*m21),  2*((m21*f1+m22*f2+f3)*m11+(m21*f4+m22*f5+f6)*m12+m21*f7+m22*f8+f9)/((-f2*m11-f5*m12-f8)^2+(f1*m11+f4*m12+f7)^2+(m21*f4+m22*f5+f6)^2+(-m21*f1-m22*f2-f3)^2)*m22*m12-((m21*f1+m22*f2+f3)*m11+(m21*f4+m22*f5+f6)*m12+m21*f7+m22*f8+f9)^2/((-f2*m11-f5*m12-f8)^2+(f1*m11+f4*m12+f7)^2+(m21*f4+m22*f5+f6)^2+(-m21*f1-m22*f2-f3)^2)^2*(-2*(-f2*m11-f5*m12-f8)*m12+2*(m21*f4+m22*f5+f6)*m22),                                   2*((m21*f1+m22*f2+f3)*m11+(m21*f4+m22*f5+f6)*m12+m21*f7+m22*f8+f9)/((-f2*m11-f5*m12-f8)^2+(f1*m11+f4*m12+f7)^2+(m21*f4+m22*f5+f6)^2+(-m21*f1-m22*f2-f3)^2)*m12-((m21*f1+m22*f2+f3)*m11+(m21*f4+m22*f5+f6)*m12+m21*f7+m22*f8+f9)^2/((-f2*m11-f5*m12-f8)^2+(f1*m11+f4*m12+f7)^2+(m21*f4+m22*f5+f6)^2+(-m21*f1-m22*f2-f3)^2)^2*(2*m21*f4+2*m22*f5+2*f6),                                   2*((m21*f1+m22*f2+f3)*m11+(m21*f4+m22*f5+f6)*m12+m21*f7+m22*f8+f9)/((-f2*m11-f5*m12-f8)^2+(f1*m11+f4*m12+f7)^2+(m21*f4+m22*f5+f6)^2+(-m21*f1-m22*f2-f3)^2)*m21-((m21*f1+m22*f2+f3)*m11+(m21*f4+m22*f5+f6)*m12+m21*f7+m22*f8+f9)^2/((-f2*m11-f5*m12-f8)^2+(f1*m11+f4*m12+f7)^2+(m21*f4+m22*f5+f6)^2+(-m21*f1-m22*f2-f3)^2)^2*(2*f1*m11+2*f4*m12+2*f7),                                   2*((m21*f1+m22*f2+f3)*m11+(m21*f4+m22*f5+f6)*m12+m21*f7+m22*f8+f9)/((-f2*m11-f5*m12-f8)^2+(f1*m11+f4*m12+f7)^2+(m21*f4+m22*f5+f6)^2+(-m21*f1-m22*f2-f3)^2)*m22-((m21*f1+m22*f2+f3)*m11+(m21*f4+m22*f5+f6)*m12+m21*f7+m22*f8+f9)^2/((-f2*m11-f5*m12-f8)^2+(f1*m11+f4*m12+f7)^2+(m21*f4+m22*f5+f6)^2+(-m21*f1-m22*f2-f3)^2)^2*(2*f2*m11+2*f5*m12+2*f8),                                                                                                                                                                                                                             2*((m21*f1+m22*f2+f3)*m11+(m21*f4+m22*f5+f6)*m12+m21*f7+m22*f8+f9)/((-f2*m11-f5*m12-f8)^2+(f1*m11+f4*m12+f7)^2+(m21*f4+m22*f5+f6)^2+(-m21*f1-m22*f2-f3)^2)];
 
 
        jac = [jac; ds*df];

    end

end


return






